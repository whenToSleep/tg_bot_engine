# üìñ Telegram Game Engine ‚Äî –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–í–µ—Ä—Å–∏—è:** 0.6.0  
**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2026-02-09

---

## üìö –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–í–≤–µ–¥–µ–Ω–∏–µ](#–≤–≤–µ–¥–µ–Ω–∏–µ)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
3. [–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã](#–æ—Å–Ω–æ–≤–Ω—ã–µ-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã)
4. [–°–∏—Å—Ç–µ–º—ã –¥–≤–∏–∂–∫–∞](#—Å–∏—Å—Ç–µ–º—ã-–¥–≤–∏–∂–∫–∞)
5. [–°–µ—Ä–≤–∏—Å—ã](#—Å–µ—Ä–≤–∏—Å—ã)
6. [–ö–æ–º–∞–Ω–¥—ã](#–∫–æ–º–∞–Ω–¥—ã)
7. [–°–æ–±—ã—Ç–∏—è](#—Å–æ–±—ã—Ç–∏—è)
8. [–ú–æ–¥—É–ª–∏](#–º–æ–¥—É–ª–∏)
9. [–ê–¥–∞–ø—Ç–µ—Ä—ã](#–∞–¥–∞–ø—Ç–µ—Ä—ã)
10. [–•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö](#—Ö—Ä–∞–Ω–µ–Ω–∏–µ-–¥–∞–Ω–Ω—ã—Ö)
11. [–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å](#–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
12. [–õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏](#–ª—É—á—à–∏–µ-–ø—Ä–∞–∫—Ç–∏–∫–∏)

---

## –í–≤–µ–¥–µ–Ω–∏–µ

### –ß—Ç–æ —Ç–∞–∫–æ–µ Telegram Game Engine?

**Telegram Game Engine** ‚Äî —ç—Ç–æ production-ready —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è multiplayer turn-based –∏–≥—Ä –≤ Telegram.

### –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

- **Command-based architecture** ‚Äî –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –∫–∞–∫ –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
- **ACID –≥–∞—Ä–∞–Ω—Ç–∏–∏** ‚Äî —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å –∏ –æ—Ç–∫–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- **Data-driven** ‚Äî –≤–µ—Å—å –∫–æ–Ω—Ç–µ–Ω—Ç –≤ JSON –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞
- **Event-driven** ‚Äî —Ä–µ–∞–∫—Ç–∏–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π
- **–ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î

### –î–ª—è –∫–∞–∫–∏—Ö –∏–≥—Ä –ø–æ–¥—Ö–æ–¥–∏—Ç?

‚úÖ **–ü–æ–¥—Ö–æ–¥–∏—Ç:**
- Turn-based RPG
- Idle/Clicker –∏–≥—Ä—ã
- Roguelike/Roguelite
- Gacha/Collection –∏–≥—Ä—ã (CCG)
- Card Battle –∏–≥—Ä—ã
- Turn-based —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

‚ùå **–ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç:**
- Real-time –∏–≥—Ä—ã (—à—É—Ç–µ—Ä—ã, –≥–æ–Ω–∫–∏)
- –ò–≥—Ä—ã —Å —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π —Å–∏–º—É–ª—è—Ü–∏–µ–π
- –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏-–∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–µ –∏–≥—Ä—ã

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –û–±—â–∞—è —Å—Ö–µ–º–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 CLIENT LAYER (UI)                       ‚îÇ
‚îÇ  Telegram Bot / Web UI / Discord / CLI                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              ADAPTER LAYER (Protocol)                   ‚îÇ
‚îÇ  ‚Ä¢ –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç UI —Å–æ–±—ã—Ç–∏—è ‚Üí Commands                   ‚îÇ
‚îÇ  ‚Ä¢ –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç Results ‚Üí UI messages                    ‚îÇ
‚îÇ  ‚Ä¢ –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ —Å async/await                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ            COMMAND LAYER (Business Logic)               ‚îÇ
‚îÇ  ‚Ä¢ GainGoldCommand                                      ‚îÇ
‚îÇ  ‚Ä¢ AttackMobCommand                                     ‚îÇ
‚îÇ  ‚Ä¢ CardFusionCommand                                    ‚îÇ
‚îÇ  ‚Ä¢ ... (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã)                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   ENGINE CORE                           ‚îÇ
‚îÇ  ‚Ä¢ CommandExecutor (sync/async)                         ‚îÇ
‚îÇ  ‚Ä¢ GameState / PersistentGameState                      ‚îÇ
‚îÇ  ‚Ä¢ EventBus (pub/sub)                                   ‚îÇ
‚îÇ  ‚Ä¢ TransactionManager                                   ‚îÇ
‚îÇ  ‚Ä¢ EntityLockManager                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ               PERSISTENCE LAYER                         ‚îÇ
‚îÇ  ‚Ä¢ EntityRepository (interface)                         ‚îÇ
‚îÇ  ‚Ä¢ SQLiteRepository (implementation)                    ‚îÇ
‚îÇ  ‚Ä¢ PostgreSQLRepository (future)                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –°–ª–æ–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

| –°–ª–æ–π | –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å | –ß—Ç–æ –∑–Ω–∞–µ—Ç |
|------|----------------|-----------|
| **Client** | UI, –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ | –ù–∏—á–µ–≥–æ –ø—Ä–æ –∏–≥—Ä–æ–≤—É—é –ª–æ–≥–∏–∫—É |
| **Adapter** | –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤ | Commands + UI |
| **Commands** | –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∏–≥—Ä—ã | GameState, Events |
| **Core** | –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –∏–∑–æ–ª—è—Ü–∏—è | –ê–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ (State, Events) |
| **Persistence** | –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö | SQL, —Ñ–∞–π–ª—ã |

### –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö

```
User Input (Telegram)
    ‚Üì
Adapter –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –≤ Command
    ‚Üì
Executor –ø–æ–ª—É—á–∞–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞ —Å—É—â–Ω–æ—Å—Ç–∏
    ‚Üì
Command –∏–∑–º–µ–Ω—è–µ—Ç GameState
    ‚Üì
State –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
    ‚Üì
Command –ø—É–±–ª–∏–∫—É–µ—Ç Events
    ‚Üì
Modules —Ä–µ–∞–≥–∏—Ä—É—é—Ç –Ω–∞ —Å–æ–±—ã—Ç–∏—è
    ‚Üì
Result –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ Adapter
    ‚Üì
Adapter –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –≤ UI message
    ‚Üì
User –≤–∏–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
```

---

## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. Command (–ö–æ–º–∞–Ω–¥–∞)

–ë–∞–∑–æ–≤–∞—è –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è –¥–ª—è –≤—Å–µ—Ö –∏–≥—Ä–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π.

**–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å:**
```python
from engine import Command, GameState
from typing import List

class Command:
    """–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –∫–æ–º–∞–Ω–¥—ã."""
    
    def get_entity_dependencies(self) -> List[str]:
        """–í–µ—Ä–Ω—É—Ç—å ID —Å—É—â–Ω–æ—Å—Ç–µ–π –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏."""
        pass
    
    def execute(self, state: GameState) -> dict:
        """–í—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É. –í–µ—Ä–Ω—É—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç."""
        pass
```

**–ü—Ä–∏–º–µ—Ä:**
```python
class GainGoldCommand(Command):
    def __init__(self, player_id: str, amount: int):
        self.player_id = player_id
        self.amount = amount
    
    def get_entity_dependencies(self) -> List[str]:
        return [self.player_id]
    
    def execute(self, state: GameState) -> dict:
        player = state.get_entity(self.player_id)
        if not player:
            raise ValueError("Player not found")
        
        old_gold = player.get("gold", 0)
        new_gold = old_gold + self.amount
        
        player["gold"] = new_gold
        state.set_entity(self.player_id, player)
        
        return {
            "old_gold": old_gold,
            "new_gold": new_gold,
            "gained": self.amount
        }
```

**–í–∞–∂–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**

- ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å ‚Äî –∫–æ–º–∞–Ω–¥–∞ –ª–∏–±–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é, –ª–∏–±–æ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è
- ‚úÖ –ò–∑–æ–ª—è—Ü–∏—è ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —á–µ—Ä–µ–∑ `get_entity_dependencies()`
- ‚úÖ –¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å ‚Äî —á–∏—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è –±–µ–∑ side effects
- ‚úÖ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ‚Äî –æ–¥–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è Telegram/Web/CLI

### 2. GameState (–°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã)

In-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏–≥—Ä–æ–≤—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π.

**–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å:**
```python
from engine import GameState

state = GameState()

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—É—â–Ω–æ—Å—Ç—å
state.set_entity("player_1", {
    "_type": "player",
    "_id": "player_1",
    "name": "Alice",
    "hp": 100,
    "gold": 50
})

# –ü–æ–ª—É—á–∏—Ç—å —Å—É—â–Ω–æ—Å—Ç—å
player = state.get_entity("player_1")

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ
if state.exists("player_1"):
    print("Player exists")

# –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å—É—â–Ω–æ—Å—Ç–∏ —Ç–∏–ø–∞
players = state.get_entities_by_type("player")

# Bulk loading (v0.5.6+)
card_ids = ["card_1", "card_2", ..., "card_30"]
cards = state.get_entities_bulk(card_ids)
# –û–¥–∏–Ω SQL –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ 30!

# –ü–æ–¥—Å—á–∏—Ç–∞—Ç—å —Å—É—â–Ω–æ—Å—Ç–∏
count = state.entity_count()

# –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ
state.clear()
```

**–¢–∏–ø—ã —Å—É—â–Ω–æ—Å—Ç–µ–π:**

–í—Å–µ —Å—É—â–Ω–æ—Å—Ç–∏ –∏–º–µ—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:
- `_type` ‚Äî —Ç–∏–ø —Å—É—â–Ω–æ—Å—Ç–∏ (player, mob, item, card, etc.)
- `_id` ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä

**–ü—Ä–∏–º–µ—Ä —Å—É—â–Ω–æ—Å—Ç–µ–π:**
```python
# –ò–≥—Ä–æ–∫
{
    "_type": "player",
    "_id": "player_123",
    "name": "Alice",
    "level": 5,
    "hp": 100,
    "max_hp": 100,
    "gold": 500,
    "exp": 1250,
    "inventory": ["item_1", "item_2"]
}

# –ú–æ–±
{
    "_type": "mob",
    "_id": "mob_456",
    "template_id": "goblin",
    "hp": 30,
    "max_hp": 30
}

# –ü—Ä–µ–¥–º–µ—Ç
{
    "_type": "item",
    "_id": "item_789",
    "template_id": "iron_sword",
    "owner_id": "player_123"
}

# –ö–∞—Ä—Ç–∞ (–¥–ª—è CCG –∏–≥—Ä)
{
    "_type": "card",
    "_id": "card_001",
    "template_id": "fire_dragon",
    "level": 3,
    "exp": 150,
    "owner_id": "player_123",
    "element": "fire",
    "rarity": "S"
}
```

### 3. PersistentGameState

GameState —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –ë–î.

**–°–æ–∑–¥–∞–Ω–∏–µ:**
```python
from engine import PersistentGameState, SQLiteRepository

# –°–æ–∑–¥–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
repo = SQLiteRepository("game.db")

# auto_flush=True - —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
state = PersistentGameState(repo, auto_flush=True)

# auto_flush=False - —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤—Ä—É—á–Ω—É—é
state = PersistentGameState(repo, auto_flush=False)
state.set_entity("player_1", player_data)
state.flush()  # –Ø–≤–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**

- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
- ‚úÖ Lazy loading ‚Äî —Å—É—â–Ω–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏
- ‚úÖ Crash recovery ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–±–æ–µ–≤
- ‚úÖ –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ ‚Äî –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ Zero data loss ‚Äî < 2ms –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ

### 4. CommandExecutor

–í—ã–ø–æ–ª–Ω–∏—Ç–µ–ª—å –∫–æ–º–∞–Ω–¥ —Å –∏–∑–æ–ª—è—Ü–∏–µ–π.

**–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π:**
```python
from engine import CommandExecutor, GameState

executor = CommandExecutor()
state = GameState()

result = executor.execute(command, state)
if result.success:
    print(result.data)
else:
    print(result.error)
```

**–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π:**
```python
from engine import AsyncCommandExecutor

executor = AsyncCommandExecutor(state)

# –û–¥–Ω–∞ –∫–æ–º–∞–Ω–¥–∞
result = await executor.execute(command)

# Batch –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
results = await executor.execute_batch([cmd1, cmd2, cmd3])

# Parallel execution (–±–µ–∑ race conditions!)
results = await executor.execute_parallel([cmd1, cmd2, cmd3])
```

**–ì–∞—Ä–∞–Ω—Ç–∏–∏:**

- ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å ‚Äî rollback –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- ‚úÖ –ò–∑–æ–ª—è—Ü–∏—è ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- ‚úÖ –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å ‚Äî –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –î–æ–ª–≥–æ–≤–µ—á–Ω–æ—Å—Ç—å ‚Äî —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î

### 5. CommandResult

–†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```python
@dataclass
class CommandResult:
    success: bool           # –£—Å–ø–µ—Ö?
    data: Dict[str, Any]    # –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
    error: Optional[str]    # –û—à–∏–±–∫–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    metadata: Dict[str, Any]  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
result = executor.execute(command, state)

if result.success:
    gold = result.data['new_gold']
    print(f"Success! Gold: {gold}")
else:
    print(f"Error: {result.error}")
    
# –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
events = result.metadata.get('events', [])
for event in events:
    print(f"Event: {event}")
```

---

## –°–∏—Å—Ç–µ–º—ã –¥–≤–∏–∂–∫–∞

### 1. Transaction System

–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ —Å rollback.

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
from engine.core.transaction import Transaction

# –°–æ–∑–¥–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
tx = Transaction(state)

try:
    # –ù–∞—á–∞—Ç—å
    tx.begin()
    
    # –ò–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
    player = state.get_entity("player_1")
    player["gold"] += 100
    state.set_entity("player_1", player)
    
    # –ó–∞–∫–æ–º–º–∏—Ç–∏—Ç—å
    tx.commit()
except Exception as e:
    # –û—Ç–∫–∞—Ç–∏—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–µ
    tx.rollback()
    raise
```

**TransactionalExecutor:**
```python
from engine.core.transaction import TransactionalExecutor

executor = TransactionalExecutor(state)

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback –ø—Ä–∏ –æ—à–∏–±–∫–µ!
result = executor.execute(command)
```

### 2. Entity Locking System

–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ race conditions —á–µ—Ä–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:**
```python
# Executor –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å—É—â–Ω–æ—Å—Ç–∏
# –∏–∑ get_entity_dependencies()

class AttackCommand(Command):
    def get_entity_dependencies(self):
        return [self.attacker_id, self.target_id]
    
    def execute(self, state):
        # –û–±–µ —Å—É—â–Ω–æ—Å—Ç–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã!
        # –ù–∏–∫–∞–∫–∞—è –¥—Ä—É–≥–∞—è –∫–æ–º–∞–Ω–¥–∞ –Ω–µ –º–æ–∂–µ—Ç –∏—Ö –∏–∑–º–µ–Ω–∏—Ç—å
        ...
```

**–í—Ä—É—á–Ω—É—é:**
```python
from engine.core.entity_lock import EntityLockManager

lock_manager = EntityLockManager()

with lock_manager.lock_entities(["player_1", "mob_1"]):
    # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–∫—Ü–∏—è
    # –°—É—â–Ω–æ—Å—Ç–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã
    ...
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**

- ‚úÖ Deadlock prevention ‚Äî —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ ID
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ
- ‚úÖ –í–ª–æ–∂–µ–Ω–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- ‚úÖ Timeout support

### 3. Event System

Pub/Sub —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–π –ª–æ–≥–∏–∫–∏.

**–°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π:**
```python
from engine.core.events import Event

@dataclass
class MobKilledEvent(Event):
    player_id: str
    mob_id: str
    mob_template_id: str
    gold_gained: int
    exp_gained: int
```

**–ü—É–±–ª–∏–∫–∞—Ü–∏—è:**
```python
from engine import get_event_bus

bus = get_event_bus()

event = MobKilledEvent(
    player_id="player_1",
    mob_id="mob_1",
    mob_template_id="goblin",
    gold_gained=10,
    exp_gained=15
)

bus.publish(event)
```

**–ü–æ–¥–ø–∏—Å–∫–∞:**
```python
def on_mob_killed(event: MobKilledEvent):
    print(f"Mob killed: {event.mob_template_id}")
    print(f"Rewards: {event.gold_gained} gold")

bus.subscribe(MobKilledEvent, on_mob_killed)
```

**–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è:**

- `MobKilledEvent` ‚Äî —É–±–∏–π—Å—Ç–≤–æ –º–æ–±–∞
- `LevelUpEvent` ‚Äî –ø–æ–≤—ã—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è
- `AchievementUnlockedEvent` ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
- `GoldGainedEvent` ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ –∑–æ–ª–æ—Ç–∞
- `ItemAcquiredEvent` ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞
- `QuestCompletedEvent` ‚Äî –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∫–≤–µ—Å—Ç–∞

### 4. Data Loading System

–ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏–∑ JSON.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```
data/
‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îú‚îÄ‚îÄ mob_schema.json
‚îÇ   ‚îú‚îÄ‚îÄ item_schema.json
‚îÇ   ‚îî‚îÄ‚îÄ card_schema.json
‚îú‚îÄ‚îÄ mobs/
‚îÇ   ‚îú‚îÄ‚îÄ goblin.json
‚îÇ   ‚îú‚îÄ‚îÄ orc.json
‚îÇ   ‚îî‚îÄ‚îÄ dragon.json
‚îú‚îÄ‚îÄ items/
‚îÇ   ‚îî‚îÄ‚îÄ health_potion.json
‚îî‚îÄ‚îÄ cards/
    ‚îú‚îÄ‚îÄ fire_dragon.json
    ‚îî‚îÄ‚îÄ water_spirit.json
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
from engine import get_global_loader

loader = get_global_loader()
loader.set_data_directory("data")

# –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
loader.load_category("mobs", "mob_schema.json")
loader.load_category("items", "item_schema.json")

# –ü–æ–ª—É—á–∏—Ç—å –æ–¥–∏–Ω —ç–ª–µ–º–µ–Ω—Ç
goblin = loader.get("mobs", "goblin")
print(goblin["name"])  # "–ì–æ–±–ª–∏–Ω"
print(goblin["hp"])    # 30

# –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã
all_mobs = loader.get_all("mobs")
for mob_id, mob_data in all_mobs.items():
    print(f"{mob_id}: {mob_data['name']}")

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
stats = loader.get_stats()
print(stats)  # {'mobs': 3, 'items': 1}
```

**JSON Schema –≤–∞–ª–∏–¥–∞—Ü–∏—è:**
```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "required": ["name", "hp", "attack"],
  "properties": {
    "name": {"type": "string"},
    "hp": {"type": "integer", "minimum": 1},
    "attack": {"type": "integer", "minimum": 0}
  }
}
```

---

## –°–µ—Ä–≤–∏—Å—ã

### 1. Gacha Service (v0.5.6+)

–°–∏—Å—Ç–µ–º–∞ –≥–∞—á–∏ –¥–ª—è –∫–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã—Ö –∏–≥—Ä.

**–°–æ–∑–¥–∞–Ω–∏–µ:**
```python
from engine.services import GachaService, PityConfig

config = PityConfig(
    soft_pity_start=70,  # –ú—è–≥–∫–∞—è –∂–∞–ª–æ—Å—Ç—å —Å 70 –∫—Ä—É—Ç–∫–∏
    hard_pity=90,        # –ì–∞—Ä–∞–Ω—Ç–∏—è –Ω–∞ 90 –∫—Ä—É—Ç–∫–µ
    rate_increase_per_pull=0.06  # +6% –∑–∞ –∫—Ä—É—Ç–∫—É
)

service = GachaService(pity_config=config)
```

**–û–¥–Ω–∞ –∫—Ä—É—Ç–∫–∞:**
```python
card = service.single_pull(
    player=player,
    card_pool=all_cards,
    rarity_weights={"N": 94, "R": 5, "S": 0.95, "SS": 0.05}
)

print(f"–ü–æ–ª—É—á–µ–Ω–æ: {card['name']} ({card['rarity']})")
```

**–ú—É–ª—å—Ç–∏-–∫—Ä—É—Ç–∫–∞ (10x):**
```python
results = service.multi_pull(
    player=player,
    card_pool=all_cards,
    count=10
)

for card in results:
    print(f"- {card['name']} ({card['rarity']})")
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**

- ‚úÖ Pity system (–º—è–≥–∫–∞—è + –∂–µ—Å—Ç–∫–∞—è –∂–∞–ª–æ—Å—Ç—å)
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—è SR/SSR –∫–∞–∂–¥—ã–µ N –∫—Ä—É—Ç–æ–∫
- ‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
- ‚úÖ Weighted random —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º–∏ –≤–µ—Å–∞–º–∏

### 2. Matchmaking Service (v0.5.6+)

PvP –º–∞—Ç—á–º–µ–π–∫–∏–Ω–≥ –∏ –ª–∏–¥–µ—Ä–±–æ—Ä–¥—ã.

**–°–æ–∑–¥–∞–Ω–∏–µ:**
```python
from engine.services import MatchmakingService

service = MatchmakingService()
```

**–î–æ–±–∞–≤–∏—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å:**
```python
service.add_to_queue(
    player_id="player_1",
    rating=1500,
    deck_power=850
)
```

**–ù–∞–π—Ç–∏ –º–∞—Ç—á:**
```python
match = service.find_match(
    player_id="player_1",
    max_rating_diff=200
)

if match:
    print(f"–ú–∞—Ç—á –Ω–∞–π–¥–µ–Ω!")
    print(f"–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫: {match['opponent_id']}")
    print(f"–†–µ–π—Ç–∏–Ω–≥: {match['opponent_rating']}")
```

**Leaderboard:**
```python
# –û–±–Ω–æ–≤–∏—Ç—å —Ä–µ–π—Ç–∏–Ω–≥
service.update_rating("player_1", 1550)

# –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–ø
top_players = service.get_leaderboard(limit=10)
for rank, player in enumerate(top_players, 1):
    print(f"{rank}. {player['player_id']}: {player['rating']}")

# –†–∞–Ω–∫ –∏–≥—Ä–æ–∫–∞
rank = service.get_player_rank("player_1")
```

### 3. Scheduler Service (v0.6.0+)

–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π.

**–ó–∞–ø—É—Å–∫:**
```python
from engine.services import get_scheduler

scheduler = get_scheduler()
await scheduler.start()
```

**–û–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è –∑–∞–¥–∞—á–∞:**
```python
task_id = scheduler.schedule_once(
    callback=expire_banner,
    delay_seconds=7200,  # –ß–µ—Ä–µ–∑ 2 —á–∞—Å–∞
    task_name="expire_flash_banner"
)
```

**–ü–æ–≤—Ç–æ—Ä—è—é—â–∞—è—Å—è –∑–∞–¥–∞—á–∞:**
```python
scheduler.schedule_recurring(
    callback=daily_reset,
    interval_seconds=86400,  # –ö–∞–∂–¥—ã–µ 24 —á–∞—Å–∞
    task_name="daily_reset"
)
```

**–û—Ç–º–µ–Ω–∞:**
```python
scheduler.cancel_task(task_id)
```

### 4. Banner Manager (v0.6.0+)

–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –±–∞–Ω–Ω–µ—Ä–∞–º–∏ –≥–∞—á–∏.

**–°–æ–∑–¥–∞–Ω–∏–µ:**
```python
from engine.services import get_banner_manager

manager = get_banner_manager()
```

**Flash –±–∞–Ω–Ω–µ—Ä (–≤—Ä–µ–º–µ–Ω–Ω—ã–π):**
```python
manager.create_flash_banner(
    banner_id="fire_rateup",
    name="Fire Rate-Up!",
    description="3x S-rank rate!",
    card_pool=fire_cards,
    duration_seconds=7200,
    custom_weights={"S": 4.5, "SS": 1.5}
)
```

**–ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π:**
```python
active = manager.get_active_banner()
if active:
    print(f"–ê–∫—Ç–∏–≤–µ–Ω: {active['name']}")
    print(f"–û—Å—Ç–∞–ª–æ—Å—å: {active['time_remaining']}s")
```

**Leaderboard:**
```python
leaderboard = manager.get_leaderboard("fire_rateup")
for entry in leaderboard:
    print(f"{entry['rank']}. {entry['player_id']}: {entry['pulls']}")
```

### 5. Raid Service (v0.6.0+)

–ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ä–µ–π–¥-–±–æ—Å—Å—ã —Å –º–∏–ª–ª–∏–∞—Ä–¥–∞–º–∏ HP.

**–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–π–¥–∞:**
```python
from engine.services import get_raid_service

service = get_raid_service(state)

raid_id = service.create_raid(
    raid_id="ancient_dragon",
    name="Ancient Dragon Lord",
    description="Legendary dragon",
    max_hp=1_000_000_000,  # 1 –º–∏–ª–ª–∏–∞—Ä–¥!
    duration_hours=48
)

service.activate_raid(raid_id)
```

**–ê—Ç–∞–∫–∞:**
```python
result = await service.attack_raid(
    raid_id="ancient_dragon",
    player_id="player_123",
    damage=25000
)

if result.success:
    print(f"–£—Ä–æ–Ω: {result.damage_dealt:,}")
    print(f"HP –±–æ—Å—Å–∞: {result.current_hp:,}/{result.max_hp:,}")
    print(f"–í–∞—à —Ä–∞–Ω–≥: {result.rank}")
```

**Leaderboard:**
```python
leaderboard = service.get_leaderboard("ancient_dragon", limit=10)
for entry in leaderboard:
    print(f"{entry['rank']}. {entry['player_id']}: {entry['total_damage']:,}")
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**

- ‚úÖ Optimistic locking (–≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry (–¥–æ 5 –ø–æ–ø—ã—Ç–æ–∫)
- ‚úÖ Concurrent attacks (500+ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ)
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–∏–ª–ª–∏–∞—Ä–¥–æ–≤ HP (int64)

---

## –ö–æ–º–∞–Ω–¥—ã

### Economy Commands

**GainGoldCommand:**
```python
from engine.commands.economy import GainGoldCommand

cmd = GainGoldCommand(player_id="player_1", amount=100)
result = executor.execute(cmd, state)
```

**SpendGoldCommand:**
```python
from engine.commands.economy import SpendGoldCommand

cmd = SpendGoldCommand(player_id="player_1", amount=50)
result = executor.execute(cmd, state)
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å —Å—Ä–µ–¥—Å—Ç–≤
```

### Combat Commands

**AttackMobCommand:**
```python
from engine.commands.combat import AttackMobCommand

cmd = AttackMobCommand(
    attacker_id="player_1",
    target_id="mob_1"
)
result = executor.execute(cmd, state)

if result.data['mob_killed']:
    print(f"–ú–æ–± —É–±–∏—Ç! +{result.data['gold_gained']} –∑–æ–ª–æ—Ç–∞")
```

### Spawning Commands

**SpawnMobCommand:**
```python
from engine.commands.spawning import SpawnMobCommand

cmd = SpawnMobCommand(
    mob_id="mob_123",
    template_id="goblin",
    data_loader=loader
)
result = executor.execute(cmd, state)
```

**SpawnItemCommand:**
```python
from engine.commands.spawning import SpawnItemCommand

cmd = SpawnItemCommand(
    item_id="item_456",
    template_id="health_potion",
    owner_id="player_1",
    data_loader=loader
)
result = executor.execute(cmd, state)
```

### Gacha Commands (v0.6.0+)

**GachaPullCommand:**
```python
from engine.commands.gacha_commands import GachaPullCommand

cmd = GachaPullCommand(
    player_id="player_1",
    banner_id="fire_rateup",
    count=10,  # 10x pull
    cost_per_pull=300
)
result = executor.execute(cmd, state)

cards = result.data['cards']
for card in cards:
    print(f"–ü–æ–ª—É—á–µ–Ω–æ: {card['name']} ({card['rarity']})")
```

### Fusion Commands (v0.6.0+)

**CardFusionCommand:**
```python
from engine.commands.fusion_commands import CardFusionCommand

cmd = CardFusionCommand(
    player_id="player_1",
    source_card_ids=["card_1", "card_2"],
    fusion_recipe_id="fire_fusion_lv2"
)
result = executor.execute(cmd, state, data_loader=loader)

if result.success:
    fused_card = result.metadata['fused_card']
    print(f"–°–æ–∑–¥–∞–Ω–∞ –∫–∞—Ä—Ç–∞: {fused_card['name']}")
```

---

## –°–æ–±—ã—Ç–∏—è

### –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è

**MobKilledEvent:**
```python
@dataclass
class MobKilledEvent(Event):
    player_id: str
    mob_id: str
    mob_template_id: str
    gold_gained: int
    exp_gained: int
```

**LevelUpEvent:**
```python
@dataclass
class LevelUpEvent(Event):
    player_id: str
    old_level: int
    new_level: int
    stat_increases: Dict[str, int]
```

**AchievementUnlockedEvent:**
```python
@dataclass
class AchievementUnlockedEvent(Event):
    player_id: str
    achievement_id: str
    reward: Dict[str, Any]
```

### –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è

```python
from engine import get_event_bus

bus = get_event_bus()

def on_level_up(event: LevelUpEvent):
    print(f"Player {event.player_id} reached level {event.new_level}!")
    
    # –í—ã–¥–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É
    if event.new_level % 5 == 0:
        # –ö–∞–∂–¥—ã–µ 5 —É—Ä–æ–≤–Ω–µ–π
        cmd = GainGoldCommand(event.player_id, 500)
        executor.execute(cmd, state)

bus.subscribe(LevelUpEvent, on_level_up)
```

---

## –ú–æ–¥—É–ª–∏

### AchievementModule

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π.

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞:**
```python
from engine.modules import AchievementModule

module = AchievementModule(state, event_bus)

# –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è
# –ø—Ä–∏ —Å–æ–±—ã—Ç–∏—è—Ö MobKilledEvent
```

**–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:**

- `first_kill` ‚Äî –ø–µ—Ä–≤–æ–µ —É–±–∏–π—Å—Ç–≤–æ
- `monster_slayer` ‚Äî 10 —É–±–∏–π—Å—Ç–≤
- `veteran_hunter` ‚Äî 50 —É–±–∏–π—Å—Ç–≤
- `boss_killer` ‚Äî —É–±–∏–π—Å—Ç–≤–æ –±–æ—Å—Å–∞

### ProgressionModule

–°–∏—Å—Ç–µ–º–∞ –æ–ø—ã—Ç–∞ –∏ —É—Ä–æ–≤–Ω–µ–π.

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞:**
```python
from engine.modules import ProgressionModule

module = ProgressionModule(state, event_bus)

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–≤—ã—à–∞–µ—Ç —É—Ä–æ–≤–µ–Ω—å
# –ø—Ä–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–º –æ–ø—ã—Ç–µ
```

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–ø—ã—Ç–∞:**
```python
module = ProgressionModule(
    state=state,
    event_bus=event_bus,
    base_exp=100,
    exp_multiplier=1.5
)
# –£—Ä–æ–≤–µ–Ω—å 2: 100 exp
# –£—Ä–æ–≤–µ–Ω—å 3: 150 exp
# –£—Ä–æ–≤–µ–Ω—å 4: 225 exp
```

---

## –ê–¥–∞–ø—Ç–µ—Ä—ã

### Telegram Adapter

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram —á–µ—Ä–µ–∑ aiogram 3.x.

**GameBot:**
```python
from engine.adapters.telegram import GameBot

bot = GameBot(
    token="YOUR_BOT_TOKEN",
    state=state,
    executor=executor
)

await bot.start()
```

**–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ:**
```python
from aiogram import types
from aiogram.filters import Command

class MyGameBot(GameBot):
    def _register_handlers(self):
        super()._register_handlers()
        
        @self.dp.message(Command("heal"))
        async def heal_handler(message: types.Message):
            # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –ª–æ–≥–∏–∫–∞
            ...
```

**ResponseBuilder:**
```python
from engine.adapters.telegram import ResponseBuilder

builder = ResponseBuilder()

# –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç
text = builder.build_profile(player)

# –ú–µ–¥–∏–∞ –∞–ª—å–±–æ–º
album = builder.build_media_album(cards, media_library)

# –ö–Ω–æ–ø–∫–∏
keyboard = builder.build_button_grid([
    ["‚öîÔ∏è –ê—Ç–∞–∫–æ–≤–∞—Ç—å", "üõ°Ô∏è –ó–∞—â–∏—Ç–∞"],
    ["üíä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–µ–ª—å–µ"]
])
```

---

## –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

### SQLiteRepository

**–°–æ–∑–¥–∞–Ω–∏–µ:**
```python
from engine import SQLiteRepository

repo = SQLiteRepository("game.db")
```

**–û–ø–µ—Ä–∞—Ü–∏–∏:**
```python
# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
repo.save_entity("player_1", player_data)

# –ó–∞–≥—Ä—É–∑–∏—Ç—å
player = repo.load_entity("player_1")

# –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ (bulk)
card_ids = ["card_1", "card_2", ..., "card_30"]
cards = repo.load_entities_bulk(card_ids)
# ~25x –±—ã—Å—Ç—Ä–µ–µ!

# –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ —Ç–∏–ø—É
all_players = repo.load_all_entities_of_type("player")

# –£–¥–∞–ª–∏—Ç—å
repo.delete_entity("mob_123")

# –°—É—â–µ—Å—Ç–≤—É–µ—Ç?
if repo.entity_exists("player_1"):
    ...
```

**–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```python
# Optimistic locking
entity["_version"] = 1

# –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:
# UPDATE entities SET data=?, version=version+1
# WHERE id=? AND version=?

# –ï—Å–ª–∏ version –∏–∑–º–µ–Ω–∏–ª–∞—Å—å - ConflictError
```

### Referral System (v0.6.0+)

**–°–æ–∑–¥–∞–Ω–∏–µ —Å–≤—è–∑–∏:**
```python
repo.add_referral(
    referrer_id="veteran_player",
    referred_id="new_player"
)
```

**–ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ä–µ–≤–æ:**
```python
tree = repo.get_referral_tree(
    player_id="veteran_player",
    depth=2,
    include_stats=True
)

print(f"–ü—Ä—è–º—ã—Ö —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤: {len(tree['direct_referrals'])}")
print(f"–í—Å–µ–≥–æ: {tree['total_referrals']}")
print(f"–ê–∫—Ç–∏–≤–Ω—ã—Ö: {tree['stats']['active_referrals']}")
```

---

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ú–µ—Ç—Ä–∏–∫–∏

| –û–ø–µ—Ä–∞—Ü–∏—è | –í—Ä–µ–º—è | Throughput |
|----------|-------|------------|
| –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã | 0.007ms | 142,857 ops/s |
| –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î | ~2ms | 500 saves/s |
| 1000 –∫–æ–º–∞–Ω–¥ | 7.81ms | - |
| Bulk loading (30 –∫–∞—Ä—Ç) | ~2ms | ~25x –±—ã—Å—Ç—Ä–µ–µ |
| Concurrent attacks (500) | <100ms | - |

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

**Bulk Loading:**
```python
# –ú–µ–¥–ª–µ–Ω–Ω–æ (30 –∑–∞–ø—Ä–æ—Å–æ–≤):
cards = []
for card_id in deck_ids:
    card = state.get_entity(card_id)
    cards.append(card)

# –ë—ã—Å—Ç—Ä–æ (1 –∑–∞–ø—Ä–æ—Å):
cards = state.get_entities_bulk(deck_ids)
```

**Auto-flush:**
```python
# Production - auto_flush=True
state = PersistentGameState(repo, auto_flush=True)

# Testing - auto_flush=False
state = PersistentGameState(repo, auto_flush=False)
# –°–æ—Ö—Ä–∞–Ω—è—Ç—å batch
state.flush()
```

**Entity Locking:**
```python
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ ID –¥–ª—è deadlock prevention
def get_entity_dependencies(self):
    return [self.player_id, self.mob_id]
# –î–≤–∏–∂–æ–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ä—Ç–∏—Ä—É–µ—Ç: ["mob_id", "player_id"]
```

---

## –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Å–∏—Å—Ç–µ–º—ã

### Stat Modifiers System

–°–∏—Å—Ç–µ–º–∞ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ –¥–ª—è –±–∞—Ñ—Ñ–æ–≤, –¥–µ–±–∞—Ñ—Ñ–æ–≤ –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —Å—Ç–∞—Ç–æ–≤ (RPG –º–µ—Ö–∞–Ω–∏–∫–∏).

**ModifierType:**
```python
from engine.core.modifiers import ModifierType

class ModifierType(Enum):
    FLAT = "flat"          # +10 attack
    PERCENT = "percent"    # +20% attack (x1.2)
    MULTIPLY = "multiply"  # x2 attack
```

**–°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞:**
```python
from engine.core.modifiers import Modifier, ModifierType

# –ë–∞—Ñ—Ñ: +50% –∞—Ç–∞–∫–∏ –Ω–∞ 3 —Ö–æ–¥–∞
buff = Modifier(
    stat="attack",
    modifier_type=ModifierType.PERCENT,
    value=0.5,
    source="buff_strength",
    duration=3
)

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Ä—É—á–Ω—É—é
final_value = buff.apply(10)  # 15.0
```

**StatCalculator:**
```python
from engine.core.modifiers import StatCalculator, add_modifier

# –°–æ–∑–¥–∞—Ç—å —Å—É—â–Ω–æ—Å—Ç—å
entity = {
    "base_attack": 10,
    "base_defense": 5,
    "modifiers": []
}

# –î–æ–±–∞–≤–∏—Ç—å –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã
add_modifier(entity, "attack", "flat", 5, "item_sword")
add_modifier(entity, "attack", "percent", 0.2, "buff_strength", duration=3)

# –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—ã
stats = StatCalculator.get_all_stats(entity)
print(stats["attack"])  # 18.0 = (10 + 5) * 1.2
```

**–ü–æ—Ä—è–¥–æ–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:**
1. –ë–∞–∑–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ + —Å—É–º–º–∞ FLAT –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤
2. –£–º–Ω–æ–∂–∏—Ç—å –Ω–∞ (1 + —Å—É–º–º–∞ PERCENT –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤)
3. –£–º–Ω–æ–∂–∏—Ç—å –Ω–∞ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ MULTIPLY –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤

### Bonus Calculator System

–°–∏—Å—Ç–µ–º–∞ –±–æ–Ω—É—Å–æ–≤ –¥–ª—è idle/clicker –∏–≥—Ä —Å –º–Ω–æ–∂–∏—Ç–µ–ª—è–º–∏.

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
from engine.core.bonuses import BonusCalculator

calc = BonusCalculator()

# –î–æ–±–∞–≤–∏—Ç—å –±–æ–Ω—É—Å—ã –æ—Ç —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
calc.add_bonus("production", "percent", 0.05, "achievement_novice")
calc.add_bonus("production", "percent", 0.10, "item_hammer")
calc.add_bonus("production", "flat", 5, "upgrade_factory")

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–∏–º–∏—Ç
calc.add_cap("production", 1000)

# –†–∞—Å—Å—á–∏—Ç–∞—Ç—å
base_production = 10
final = calc.calculate("production", base_production)
# (10 + 5) * (1 + 0.05 + 0.10) = 17.25
```

**–†–∞–±–æ—Ç–∞ —Å —Å—É—â–Ω–æ—Å—Ç—è–º–∏:**
```python
from engine.core.bonuses import (
    load_bonuses_from_entity,
    save_bonuses_to_entity,
    calculate_bonus_summary
)

# –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –∏–≥—Ä–æ–∫–∞
calc = load_bonuses_from_entity(player)

# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±—Ä–∞—Ç–Ω–æ
save_bonuses_to_entity(player, calc)

# –°–≤–æ–¥–∫–∞ –±–æ–Ω—É—Å–æ–≤
summary = calculate_bonus_summary(calc, "gold")
```

### Entity Status System

–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞–º–∏ —Å—É—â–Ω–æ—Å—Ç–µ–π (—Ç–æ—Ä–≥–æ–≤–ª—è, —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∞, –∞—É–∫—Ü–∏–æ–Ω—ã).

**–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã:**
```python
from engine.core.entity_status import EntityStatus

class EntityStatus(Enum):
    ACTIVE = "active"          # –î–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    LOCKED = "locked"          # –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞
    ON_AUCTION = "on_auction"  # –ù–∞ –∞—É–∫—Ü–∏–æ–Ω–µ
    IN_TRADE = "in_trade"      # –í –æ–±–º–µ–Ω–µ
    EQUIPPED = "equipped"      # –≠–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–∞
    CONSUMED = "consumed"      # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞
    RESERVED = "reserved"      # –ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∞
```

**–†–∞–±–æ—Ç–∞ —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏:**
```python
from engine.core.entity_status import (
    set_status,
    get_status,
    has_status,
    is_usable,
    is_tradable
)

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
set_status(card, EntityStatus.ON_AUCTION)

# –ü—Ä–æ–≤–µ—Ä–∫–∏
if is_usable(card):
    # –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –±–æ—é
    ...

if is_tradable(card):
    # –ú–æ–∂–Ω–æ –ø—Ä–æ–¥–∞—Ç—å/–æ–±–º–µ–Ω—è—Ç—å
    ...
```

**–í–∞–ª–∏–¥–∞—Ü–∏—è –≤ –∫–æ–º–∞–Ω–¥–∞—Ö:**
```python
from engine.core.entity_status import StatusValidator

class UseCardCommand(Command):
    def execute(self, state):
        card = state.get_entity(self.card_id)
        
        validator = StatusValidator()
        validator.require_usable(card, "Cannot use this card")
        
        # –í—ã–ø–æ–ª–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–∞—Ä—Ç–∞ usable
        ...
```

### Unique Entity System

–°–æ–∑–¥–∞–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ —Å—É—â–Ω–æ—Å—Ç–µ–π (–∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è CCG/Gacha).

**–°–æ–∑–¥–∞–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤:**
```python
from engine.core.unique_entity import create_unique_entity

# –ü—Ä–æ—Ç–æ—Ç–∏–ø –∫–∞—Ä—Ç—ã
card_template = {
    "proto_id": "dragon_legendary",
    "name": "Ancient Dragon",
    "rarity": "S",
    "base_attack": 100
}

# –°–æ–∑–¥–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
card = create_unique_entity(
    card_template,
    entity_type="card",
    owner_id="player_123",
    custom_fields={"level": 1, "exp": 0}
)

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
# {
#     "_id": "card_a1b2c3d4",  # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
#     "_type": "card",
#     "proto_id": "dragon_legendary",
#     "owner_id": "player_123",
#     "status": "active",
#     "level": 1,
#     "exp": 0,
#     ...
# }
```

**–†–∞–±–æ—Ç–∞ —Å –∫–æ–ª–ª–µ–∫—Ü–∏—è–º–∏:**
```python
from engine.core.unique_entity import (
    group_by_prototype,
    count_by_prototype,
    is_same_prototype
)

# –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞–º
grouped = group_by_prototype(player_cards)
# {"dragon_legendary": [card1, card2], "goblin_common": [card3, card4, card5]}

# –ü–æ–¥—Å—á—ë—Ç
counts = count_by_prototype(player_cards)
# {"dragon_legendary": 2, "goblin_common": 3}

# –ü—Ä–æ–≤–µ—Ä–∫–∞
if is_same_prototype(card1, card2):
    # –û–±–µ –∫–∞—Ä—Ç—ã - –∫–æ–ø–∏–∏ –æ–¥–Ω–æ–≥–æ –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞
    ...
```

### Utilities

–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏–≥—Ä–æ–≤–æ–π –º–µ—Ö–∞–Ω–∏–∫–∏.

**Weighted Random:**
```python
from engine.core import utils

# Weighted choice –¥–ª—è –ª—É—Ç–∞
loot_table = [
    {"item_id": "sword", "weight": 70},
    {"item_id": "gem", "weight": 30}
]
result = utils.weighted_choice(loot_table, "weight")

# Roll loot table
loot = [
    {"item_id": "gold", "chance": 1.0, "min_quantity": 5, "max_quantity": 10},
    {"item_id": "gem", "chance": 0.1}
]
dropped = utils.roll_loot_table(loot)

# Gacha pull
cards = [{"id": "card1", "rarity": "common"}, ...]
rarity_weights = {"common": 99, "legendary": 1}
pulled = utils.gacha_pull(cards, rarity_weights)
```

**Idle/Clicker Utilities:**
```python
import time

# Offline progress
last_login = time.time() - 10 * 3600  # 10 —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥
result = utils.calculate_offline_progress(
    last_login,
    time.time(),
    production_rate_per_second=10.0,
    max_offline_hours=8
)
# {"offline_seconds": 28800, "earned": 288000, "was_capped": True}

# Exponential cost
cost = utils.calculate_exponential_cost(100, level=10, multiplier=1.15)
# 404 (—Å—Ç–æ–∏–º–æ—Å—Ç—å 11-–≥–æ —É—Ä–æ–≤–Ω—è)

# Exponential production
production = utils.calculate_exponential_production(1.0, level=10, multiplier=1.07)
# 1.97 (–ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –Ω–∞ 10 —É—Ä–æ–≤–Ω–µ)
```

**Collection Management:**
```python
# Merge stacks
inventory = {"potion": 95}
result = utils.merge_item_stacks(inventory, "potion", 10, max_stack=99)
# {"added": 4, "overflow": 6, "new_quantity": 99}

# Filter entities
players = utils.filter_entities(
    all_entities,
    lambda e: e.get("level", 0) > 10
)
```

### Media Library

–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ file_id –¥–ª—è Telegram –º–µ–¥–∏–∞ (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è).

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
from engine.adapters.telegram import get_media_library

library = get_media_library()

# –í —Ö–µ–Ω–¥–ª–µ—Ä–µ
async def send_card_image(message, card_id):
    local_path = f"images/cards/{card_id}.png"
    
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫—ç—à
    file_id = library.get_file_id(local_path)
    
    if file_id:
        # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à
        await message.answer_photo(file_id)
    else:
        # –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞—Ç—å
        from aiogram.types import FSInputFile
        msg = await message.answer_photo(FSInputFile(local_path))
        library.save_file_id(local_path, msg.photo[-1].file_id)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –≠–∫–æ–Ω–æ–º–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞ (–Ω–µ –∑–∞–≥—Ä—É–∂–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ)
- ‚úÖ –ë—ã—Å—Ç—Ä–µ–µ (–º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞)
- ‚úÖ –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫—ç—à–∞ –≤ JSON

---

## –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

### 1. –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã

‚ùå **–ü–ª–æ—Ö–æ:**
```python
player = state.get_entity("player_1")
player["gold"] += 100
state.set_entity("player_1", player)
```

‚úÖ **–•–æ—Ä–æ—à–æ:**
```python
cmd = GainGoldCommand("player_1", 100)
result = executor.execute(cmd, state)
```

### 2. –û–±—ä—è–≤–ª—è–π—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

‚ùå **–ü–ª–æ—Ö–æ:**
```python
class MyCommand(Command):
    def get_entity_dependencies(self):
        return []  # –ó–∞–±—ã–ª–∏!
```

‚úÖ **–•–æ—Ä–æ—à–æ:**
```python
class MyCommand(Command):
    def get_entity_dependencies(self):
        return [self.player_id, self.target_id]
```

### 3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ–±—ã—Ç–∏—è

‚ùå **–ü–ª–æ—Ö–æ:**
```python
# –í—Å—è –ª–æ–≥–∏–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ
class AttackCommand(Command):
    def execute(self, state):
        # –ê—Ç–∞–∫–∞
        ...
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
        ...
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–µ—Å—Ç–æ–≤
        ...
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ä–æ–≤–Ω—è
        ...
```

‚úÖ **–•–æ—Ä–æ—à–æ:**
```python
class AttackCommand(Command):
    def execute(self, state):
        # –¢–æ–ª—å–∫–æ –∞—Ç–∞–∫–∞
        ...
        # –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ
        bus.publish(MobKilledEvent(...))
        # –ú–æ–¥—É–ª–∏ —Å—Ä–µ–∞–≥–∏—Ä—É—é—Ç —Å–∞–º–∏!
```

### 4. –í–∞–ª–∏–¥–∏—Ä—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ

‚ùå **–ü–ª–æ—Ö–æ:**
```python
def execute(self, state):
    player["gold"] -= 100  # –ú–æ–∂–µ—Ç —É–π—Ç–∏ –≤ –º–∏–Ω—É—Å!
```

‚úÖ **–•–æ—Ä–æ—à–æ:**
```python
def execute(self, state):
    if player.get("gold", 0) < 100:
        raise ValueError("Insufficient gold")
    player["gold"] -= 100
```

### 5. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ DataLoader

‚ùå **–ü–ª–æ—Ö–æ:**
```python
# –•–∞—Ä–¥–∫–æ–¥ –≤ –∫–æ–¥–µ
goblin_data = {
    "name": "–ì–æ–±–ª–∏–Ω",
    "hp": 30,
    "attack": 5
}
```

‚úÖ **–•–æ—Ä–æ—à–æ:**
```python
# JSON —Ñ–∞–π–ª
goblin = loader.get("mobs", "goblin")
```

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

Telegram Game Engine –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è production-ready –∏–≥—Ä–æ–≤—ã—Ö –±–æ—Ç–æ–≤.

**–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- ‚úÖ –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å ‚Äî ACID –≥–∞—Ä–∞–Ω—Ç–∏–∏, –Ω–µ—Ç race conditions
- ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å ‚Äî —Ç—ã—Å—è—á–∏ –∏–≥—Ä–æ–∫–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- ‚úÖ –ì–∏–±–∫–æ—Å—Ç—å ‚Äî data-driven, event-driven
- ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Äî < 10ms –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—é
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è ‚Äî 100% coverage

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**

1. –ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ [QUICKSTART.md](QUICKSTART.md)
2. –ò–∑—É—á–∏—Ç–µ [API_REFERENCE.md](API_REFERENCE.md)
3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≥–æ—Ç–æ–≤—ã–µ —à–∞–±–ª–æ–Ω—ã –≤ –ø–∞–ø–∫–µ `templates/`
4. –°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é –∏–≥—Ä—É!

---

**–í–µ—Ä—Å–∏—è:** 0.6.0  
**–î–∞—Ç–∞:** 2026-02-09  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ Production Ready
